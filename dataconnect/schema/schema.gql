# ===================================================================
# Grade Web App - Data Connect Schema
# Definición del esquema de datos para la aplicación de gestión de calificaciones
# ===================================================================

type User @table(name: "users", key: "userId") {
  # Identificador único del usuario
  userId: UUID! @col(name: "user_id")

  # Identificador de firebase Auth
  firebaseId: String! @col(name: "firebase_id")
  
  # Nombre del usuario
  name: String!
  
  # Correo electrónico del usuario
  email: String! @unique
  
  # Rol del usuario (Admin/Coordinator/Teacher)
  role: String!
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")

  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")

  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type Subject @table(name: "subjects", key: "subjectId") {
  # Identificador único de la asignatura
  subjectId: UUID! @col(name: "subject_id")
  
  # Nombre de la asignatura
  name: String!
  
  # Código de la asignatura (ej. MAT-101, ENG-102)
  code: String!
  
  # Descripción de la asignatura
  description: String
  
  # ID del nivel educacional al que pertenece esta asignatura
  levelId: UUID! @col(name: "level_fk")
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type Unit @table(name: "units", key: "unitId") {
  # Identificador único de la unidad
  unitId: UUID! @col(name: "unit_id")
  
  # Identificador de la asignatura padre
  subjectId: UUID! @col(name: "subject_fk")
  
  # Código de la unidad (ej. UNIT_1, UNIT_2)
  code: String! @unique
  
  # Nombre de la unidad
  name: String!
  
  # Descripción de la unidad
  description: String
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type Topic @table(name: "topics", key: "topicId") {
  # Identificador único del tema
  topicId: UUID! @col(name: "topic_id")
  
  # Identificador de la unidad padre
  unitId: UUID! @col(name: "unit_fk")
  
  #Código del tema (ej. TOPIC_1, TOPIC_2)
  code: String! @unique
  
  # Nombre del tema
  name: String!
  
  # Descripción del tema
  description: String
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type QuestionType @table(name: "question_types", key: "questionTypeId") {
  # Identificador único del tipo de pregunta
  questionTypeId: UUID! @col(name: "question_type_id")
  
  # Código del tipo (TF, SC, MC)
  code: String!
  
  # Nombre del tipo de pregunta
  name: String!

  # Descripción del tipo de pregunta
  description: String
  
  # Cantidad minima de opciones
  minOptions: Int!
  
  # Cantidad máxima de opciones
  maxOptions: Int!
  
  # Cantidad de opciones correctas
  correctOptions: Int!
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
}

type Difficulty @table(name: "difficulties", key: "difficultyId") {
  # Identificador único del nivel de dificultad
  difficultyId: UUID! @col(name: "difficulty_id")

  # Código del nivel de dificultad (EASY, MEDIUM, HARD)
  code: String! @unique
  
  # Nivel de dificultad (Easy/Medium/Hard)
  level: String!
  
  # Peso o ponderador opcional
  weight: Float!

  # Descripción del tipo de pregunta
  description: String
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
}

type Taxonomy @table(name: "taxonomies", key: "taxonomyId") {
  # Identificador único de la taxonomía
  taxonomyId: UUID! @col(name: "taxonomy_id")
  
  # Código de la taxonomía (ej. REMEMBER, UNDERSTAND, APPLY, ANALYZE, EVALUATE, CREATE)
  code: String! @unique
  
  # Nombre de la taxonomía
  name: String!
  
  # Descripción de la taxonomía
  description: String
  
  # Nivel de Bloom (1-6)
  level: Int!
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type Question @table(name: "questions", key: "questionId") {
  # Identificador único de la pregunta
  questionId: UUID! @col(name: "question_id")
  
  # Texto de la pregunta
  text: String!
  
  # Indica si la pregunta está activa
  active: Boolean! @default(value: true)
  
  # Número de versión de la pregunta
  version: Int! @default(value: 1)
  
  # ID de la pregunta original (para versiones)
  originalQuestionId: UUID @col(name: "original_question_fk")
  
  # ID del tema al que pertenece
  topicId: UUID! @col(name: "topic_fk")
  
  # ID del nivel de dificultad
  difficultyId: UUID! @col(name: "difficulty_fk")
  
  # ID de la taxonomía
  taxonomyId: UUID! @col(name: "taxonomy_fk")
  
  # ID del tipo de pregunta
  questionTypeId: UUID! @col(name: "question_type_fk")
  
  # ID del usuario creador
  userId: UUID! @col(name: "user_fk")
  
  # Habilita puntaje parcial para preguntas de opción múltiple
  allowPartialScore: Boolean! @col(name: "allow_partial_score") @default(value: false)

  # Indicador de pregunta pública o privada
  isPublic: Boolean! @col(name: "is_public") @default(value: false)
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type QuestionOption @table(name: "question_options", key: "questionOptionId") {
  # Identificador único de la opción de pregunta
  questionOptionId: UUID! @col(name: "question_option_id")
  
  # Texto de la opción
  text: String!
  
  # Indica si esta es la opción correcta
  isCorrect: Boolean! @col(name: "is_correct")
  
  # Posición de la opción (1..n)
  position: Int!
  
  # Puntuación asociada a esta opción
  score: Float
  
  # ID de la pregunta a la que pertenece
  questionId: UUID! @col(name: "question_fk")
}

type LevelCategory @table(name: "level_categories", key: "categoryId") {
  # Identificador único de la categoría de nivel
  categoryId: UUID! @col(name: "category_id")
  
  # Código de la categoría (ej. CAT_BASIC, CAT_MEDIA)
  code: String! @unique
  
  # Nombre de la categoría
  name: String!
  
  # Descripción de la categoría
  description: String
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type EducationalLevel @table(name: "educational_levels", key: "levelId") {
  # Identificador único del nivel educacional
  levelId: UUID! @col(name: "level_id")
  
  # Identificador de la categoría padre
  categoryId: UUID! @col(name: "category_fk")
  
  # Código del nivel (ej. LEVEL_1B, LEVEL_2M)
  code: String! @unique
  
  # Nombre del nivel (ej. 1° Básico, 1° Medio)
  name: String!
  
  # Descripción del nivel
  description: String
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type Course @table(name: "courses", key: "courseId") {
  # Identificador único del curso
  courseId: UUID! @col(name: "course_id")
  
  # Nombre del curso (ej. 1° Básico A, 2° Medio B)
  name: String!
  
  # Código del curso (ej. 1_Basico_A, 2_Medio_B)
  code: String! @unique
  
  # Sección del curso (A, B, C)
  section: String
  
  # Institución educativa a la que pertenece el curso
  institutionName: String! @col(name: "institution_name")
  
  # ID del nivel educacional
  levelId: UUID! @col(name: "level_fk")
  
  # ID del usuario asociado al curso
  userId: UUID! @col(name: "user_fk")
  
  # Indicador de activo/inactivo
  active: Boolean! @default(value: true)
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type Evaluation @table(name: "evaluations", key: "evaluationId") {
  # Identificador único de la evaluación
  evaluationId: UUID! @col(name: "evaluation_id")
  
  # Título de la evaluación
  title: String!
  
  # Escala de calificación (ej. "0-100_to_1-7")
  gradeScale: String! @col(name: "grade_scale")
  
  # Estado de la evaluación (Draft/Published/Applied/Graded/Archived)
  state: String!
  
  # Permite asignar un subconjunto aleatorio de preguntas a cada estudiante
  allowQuestionSubset: Boolean! @col(name: "allow_question_subset") @default(value: false)
  
  # Porcentaje de preguntas a asignar cuando allowQuestionSubset está habilitado (1-100)
  questionSubsetPercent: Int @col(name: "question_subset_percent")
  
  # Ruta del archivo PDF
  pdfPath: String @col(name: "pdf_path")
  
  # ID de la asignatura
  subjectId: UUID! @col(name: "subject_fk")
  
  # ID del usuario creador
  userId: UUID! @col(name: "user_fk")
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type EvaluationQuestion @table(name: "evaluation_questions", key: "evaluationQuestionId") {
  # Identificador único de la pregunta de evaluación
  evaluationQuestionId: UUID! @col(name: "evaluation_question_id")
  
  # ID de la evaluación
  evaluationId: UUID! @col(name: "evaluation_fk")
  
  # ID de la pregunta
  questionId: UUID! @col(name: "question_fk")
  
  # Puntos asignados a la pregunta
  points: Float!
  
  # Posición de la pregunta en la evaluación
  position: Int!
}

type CourseEvaluation @table(name: "course_evaluations", key: "courseEvaluationId") {
  # Identificador único de la evaluación del curso
  courseEvaluationId: UUID! @col(name: "course_evaluation_id")
  
  # ID del curso
  courseId: UUID! @col(name: "course_fk")
  
  # ID de la evaluación
  evaluationId: UUID! @col(name: "evaluation_fk")
  
  # Fecha programada de la evaluación para este curso
  scheduledDate: Date! @col(name: "scheduled_date")
  
  # Duración en minutos para este curso
  durationMinutes: Int! @col(name: "duration_minutes")
  
  # Código de acceso corto para fallback del QR (generado automáticamente)
  accessCode: String @col(name: "access_code")
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
}

type Student @table(name: "students", key: "studentId") {
  # Identificador único del estudiante
  studentId: UUID! @col(name: "student_id")
  
  # Nombre del estudiante
  firstName: String! @col(name: "first_name")
  
  # Apellido del estudiante
  lastName: String! @col(name: "last_name")
  
  # Identificador único del estudiante (RUT, ID, etc.)
  identifier: String! @unique
  
  # Email del estudiante
  email: String! @col(name: "email")
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type CourseStudent @table(name: "course_students", key: "courseStudentId") {
  # Identificador único de la matrícula
  courseStudentId: UUID! @col(name: "course_student_id")
  
  # ID del curso
  courseId: UUID! @col(name: "course_fk")
  
  # Referencia al curso
  course: Course! @ref(fields: "courseId", references: "courseId")
  
  # ID del estudiante
  studentId: UUID! @col(name: "student_fk")
  
  # Referencia al estudiante
  student: Student! @ref(fields: "studentId", references: "studentId")
  
  # Fecha de matrícula
  enrolledOn: Date! @col(name: "enrolled_on")
  
  # Fecha de creación
  createdAt: Timestamp! @col(name: "created_at") @default(expr: "request.time")
  
  # ID del usuario que realizó la creación
  createdBy: UUID! @col(name: "created_by")
  
  # Fecha de última actualización
  updatedAt: Timestamp @col(name: "updated_at")
  
  # ID del usuario que realizó la última actualización
  updatedBy: UUID @col(name: "updated_by")
  
  # Fecha de eliminación (soft delete)
  deletedAt: Timestamp @col(name: "deleted_at")
  
  # ID del usuario que realizó la eliminación
  deletedBy: UUID @col(name: "deleted_by")
}

type StudentCourseEvaluation @table(name: "student_evaluations", key: "studentCourseEvaluationId") {
  # Identificador único de la rendición
  studentCourseEvaluationId: UUID! @col(name: "student_evaluation_id")
  
  # ID del curso-evaluación (garantiza que la evaluación pertenece a un curso específico)
  courseEvaluationId: UUID! @col(name: "course_evaluation_fk")

  # ID del curso-estudiante (garantiza que el estudiante pertenece a ese curso)
  courseStudentId: UUID! @col(name: "course_student_fk")

  # Puntaje total obtenido
  totalScore: Float! @col(name: "total_score") @default(value: 0)
  
  # Nota final
  grade: Float
  
  # Fecha de rendición
  takenOn: Timestamp @col(name: "taken_on")
  
  # Número de intento
  attemptNo: Int @col(name: "attempt_no")
  
  # Estado de la rendición: CREATED, ASSIGNED, IN_PROGRESS, COMPLETED, GRADED
  state: String! @default(value: "CREATED")
}

type StudentEvaluationQuestion @table(name: "student_evaluation_questions", key: "studentEvaluationQuestionId") {
  # Identificador único de la pregunta asignada al estudiante
  studentEvaluationQuestionId: UUID! @col(name: "student_evaluation_question_id")
  
  # ID de la rendición del estudiante
  studentEvaluationId: UUID! @col(name: "student_evaluation_fk")
  
  # ID de la pregunta de evaluación (del pool de preguntas de la evaluación)
  evaluationQuestionId: UUID! @col(name: "evaluation_question_fk")
  
  # Posición de la pregunta en la evaluación del estudiante
  position: Int!
  
  # Puntaje obtenido por el estudiante en esta pregunta
  scoreObtained: Float @col(name: "score_obtained")
  
  # Indica si la respuesta es correcta
  isCorrect: Boolean @col(name: "is_correct")
}

type StudentAnswerOption @table(name: "student_answer_options", key: "studentAnswerOptionId") {
  # Identificador único de la selección de alternativa
  studentAnswerOptionId: UUID! @col(name: "student_answer_option_id")
  
  # ID de la pregunta asignada al estudiante
  studentEvaluationQuestionId: UUID! @col(name: "student_evaluation_question_fk")
  
  # ID de la opción de pregunta seleccionada
  questionOptionId: UUID! @col(name: "question_option_fk")
}
